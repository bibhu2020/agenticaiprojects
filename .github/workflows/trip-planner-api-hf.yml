name: Deploy AI Trip-planner Api to Hugging Face

env:
  PROJECT_PATH: projects/ai-trip-planner
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  HF_USERNAME: ${{ secrets.HF_USERNAME }}
  HF_SPACE_NAME: ${{ secrets.HF_SPACE_TRIP_PLANNER_API }}
  REPO_ID: ${{ secrets.HF_USERNAME }}/${{ secrets.HF_SPACE_TRIP_PLANNER_API }}

on:
  push:
    branches:
      - main
    paths:
      - 'projects/ai-trip-planner/**'
  workflow_dispatch:

jobs:
  upload-to-hf:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub

    - name: Create upload script
      run: |
        cat << 'EOF' > upload_to_hf.py
        from huggingface_hub import HfApi, create_repo
        import os
        import sys
        from pathlib import Path

        # Get environment variables
        PROJECT_PATH = os.environ["PROJECT_PATH"]
        REPO_ID = os.environ["REPO_ID"]
        TOKEN = os.environ["HF_TOKEN"]

        def should_exclude(path):
            """Check if a file or directory should be excluded from upload"""
            exclusions = {
                '.env', '.env.*', '.venv', 'venv', 
                '__pycache__', '*.pyc', '.git',
                '.pytest_cache', '.coverage'
            }
            
            path_parts = Path(path).parts
            return any(
                any(part.startswith(excl.replace('*', '')) for part in path_parts)
                for excl in exclusions
            )

        def main():
            # Initialize the Hugging Face API
            api = HfApi()
            
            try:
                # Try to create the repository
                create_repo(
                    repo_id=REPO_ID,
                    token=TOKEN,
                    repo_type="space",
                    space_sdk="gradio",
                    private=False
                )
                print(f"Created new repository: {REPO_ID}")
            except Exception as e:
                if "You already created this space" in str(e):
                    print(f"Repository {REPO_ID} already exists")
                else:
                    print(f"Error creating repository: {e}")
                    sys.exit(1)
            
            try:
                # Upload the folder with exclusions
                print(f"Uploading files to {REPO_ID}...")
                api.upload_folder(
                    folder_path=PROJECT_PATH,
                    repo_id=REPO_ID,
                    repo_type="space",
                    token=TOKEN,
                    ignore_patterns=[
                        ".env*",
                        ".venv/**",
                        "venv/**",
                        "__pycache__/**",
                        "*.pyc",
                        ".git/**",
                        ".pytest_cache/**",
                        ".coverage"
                    ]
                )
                print("Upload completed successfully")
            except Exception as e:
                print(f"Error uploading files: {e}")
                sys.exit(1)

        if __name__ == "__main__":
            main()
        EOF

    - name: Upload to Hugging Face Hub
      run: python upload_to_hf.py