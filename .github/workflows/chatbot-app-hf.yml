name: Deploy Chatbot API to Hugging Face

env:
  PROJECT_PATH: chatbot
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  HF_USERNAME: ${{ secrets.HF_USERNAME }}
  HF_SPACE_NAME: chatbot-app
  REPO_ID: ${{ secrets.HF_USERNAME }}/chatbot-app

on:
  push:
    branches:
      - main
    paths:
      - 'chatbot/**'
  workflow_dispatch:

jobs:
  upload-to-hf:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Copy uv.lock and pyproject.toml to project folder
      run: |
        if [ -f "uv.lock" ]; then
          cp uv.lock "${{ env.PROJECT_PATH }}/"
          echo "Copied uv.lock to ${{ env.PROJECT_PATH }}"
        fi
        if [ -f "pyproject.toml" ]; then
          cp pyproject.toml "${{ env.PROJECT_PATH }}/"
          echo "Copied pyproject.toml to ${{ env.PROJECT_PATH }}"
        fi

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub

    - name: Create upload script
      run: |
        cat << 'EOF' > upload_to_hf.py
        from huggingface_hub import HfApi, create_repo
        import os
        import sys
        from pathlib import Path

        PROJECT_PATH = os.environ["PROJECT_PATH"]
        REPO_ID = os.environ["REPO_ID"]
        TOKEN = os.environ["HF_TOKEN"]

        def main():
            # Authenticate
            api = HfApi()

            # Create the Space if it doesn't exist
            try:
                create_repo(
                    repo_id=REPO_ID,
                    token=TOKEN,
                    repo_type="space",
                    space_sdk="docker",
                    private=False
                )
                print(f"Created new repository: {REPO_ID}")
            except Exception as e:
                if "You already created this space" in str(e):
                    print(f"Repository {REPO_ID} already exists")
                else:
                    print(f"Error creating repository: {e}")
                    sys.exit(1)

            # Upload folder
            try:
                print(f"Uploading files from {PROJECT_PATH} to {REPO_ID}...")
                api.upload_folder(
                    folder_path=PROJECT_PATH,
                    repo_id=REPO_ID,
                    repo_type="space",
                    token=TOKEN,
                    ignore_patterns=[
                        ".env*",
                        ".venv/**",
                        "venv/**",
                        "__pycache__/**",
                        "*.pyc",
                        ".git/**",
                        ".pytest_cache/**",
                        ".coverage",
                        "dockers/**",
                    ],
                )
                print("Upload completed successfully")
            except Exception as e:
                print(f"Error uploading files: {e}")
                sys.exit(1)

        if __name__ == "__main__":
            main()
        EOF

    - name: Upload to Hugging Face Hub
      run: python upload_to_hf.py
